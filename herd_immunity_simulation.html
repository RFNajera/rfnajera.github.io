<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herd Immunity Simulation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #f0f8ff;
        }

        canvas {
            border: 1px solid #000;
            margin-top: 20px;
        }

        #controls {
            flex-direction: column;
            align-items: center;
        }

        .input-container {
            margin: 10px 0;
        }

        label {
            font-size: 14px;
        }

        input[type="number"] {
            margin-top: 5px;
            width: 60px;
        }

        #result {
            margin-top: 20px;
            font-size: 16px;
            font-weight: bold;
        }

        table {
            margin-top: 20px;
            border-collapse: collapse;
        }

        table,
        th,
        td {
            border: 1px solid black;
        }

        th,
        td {
            padding: 5px 10px;
            text-align: center;
        }
    </style>
</head>

<body>
    <h1>Herd Immunity Simulation (v0.4)</h1>
    <div id="instructions"
        style="max-width: 800px; text-align: left; margin-top: 20px; margin-bottom: 20px; font-size: 16px; line-height: 1.5;">
        <h2>Background Information</h2>
        <p>
            This simulator shows you how herd immunity works from a mathematical point of view. We make several
            assumptions:
        </p>
        <ul>
            <li>
                The population is closed. No new people come in or leave the population. It remains steady at whatever
                number you choose.
            </li>
            <li>
                Meetings of people (when dots cross each other) are completely at random. We know this is not the case
                in the real world. We congregate with people who are like us, people we work with, people we go to
                school with, or people who ride public transportation with us. Those congregations and "touch points"
                may not be at random. (In fact, many are not.)
            </li>
            <li>
                The percent vaccinated remains what you picked. Often times, people who are not vaccinated will get
                vaccinated during an outbreak
            </li>
            <li>
                The R-naught (R<sub>0</sub>, which is the number of people one case infects) remains the same throughout
                the outbreak. This is often not the case, as intervention measures can and do change how many people a
                case may infect.
            </li>
            <li>
                The "Infection to Infectious Time" remains constant, and the "Infectious Period" is the same for
                everyone. This is often not the case. The times from exposure to infection, infection to disease, and
                disease to recovery vary from person to person. These times depend on many factors like the
                pathogenicity and virulence of the strain, the infected person's immune response, and their general
                health.
            </li>
        </ul>
        <h2>Instructions</h2>
        <p>
            Choose from the value options in the boxes below, and then click on "Start Simulation". The simulation will
            begin, and you will see a timer below the simulation telling you how much time has passed since the outbreak
            started.
        </p>
        <p>
            The simulation will end after two incubation periods without any cases (red dots). This is often how we
            declare epidemics to be over.
        </p>
        <h2>Take Note!</h2>
        <p>
            Note the differences in the number of cases, the attack rates between vaccinated and unvaccinated, etc. Pay
            attention to the histogram of cases (aka "Epi Curve") at the bottom once the simulation ends.
        </p>
        <p>
            Pay attention to the vaccine effectiveness and percent vaccinated, and go above or below the <i>Herd
                Immunity Threshold</i>, whose value depends on the R<sub>0</sub> value:
        </p>
        <div style="text-align: center;"><math xmlns="http://www.w3.org/1998/Math/MathML">
                <mi>H</mi>
                <sub>
                    <mi>c</mi>
                </sub>
                <mo>=</mo>
                <mn>1</mn>
                <mo>-</mo>
                <mfrac>
                    <mn>1</mn>
                    <mi>R</mi>
                    <sub>
                        <mn>0</mn>
                    </sub>
                </mfrac>
            </math>
        </div>
        <p>
            Notice how different the number of cases in the vaccinated and unvaccinated are, depending on the value of "Percent Vaccinated" versus the threshold. And notice the speed at which the outbreak happens.
        </p>
    </div>

    </div>
    <div id="controls">
        <div class="input-container">
            <label for="population">Population Size (50-1000):</label><br>
            <input type="number" id="population" min="50" max="2000" step="10" value="1000">
        </div>
        <div class="input-container">
            <label for="vaccinated">Percent Vaccinated:</label><br>
            <input type="number" id="vaccinated" min="0" max="100" step="1" value="95">
        </div>
        <div class="input-container">
            <label for="infection-rate">R<sub>0</sub>:</label><br>
            <select id="infection-rate">
                <option value="2">Seasonal Flu: 2</option>
                <option value="2.5">Ebola: 2.5</option>
                <option value="2.6">Diphtheria: 2.6</option>
                <option value="3">Common Cold: 3</option>
                <option value="7">Mumps: 7</option>
                <option value="8">COVID-19 (Delta): 8</option>
                <option value="12">Chickenpox: 12</option>
                <option value="18" selected>Measles: 18</option>
            </select>
        </div>
        <div class="input-container">
            <label for="initial-infected">Number of Initial Infections (1-50):</label><br>
            <input type="number" id="initial-infected" min="1" max="50" step="1" value="1">
        </div>
        <div class="input-container">
            <label for="vaccine-effectiveness">Vaccine Effectiveness (0-100%):</label><br>
            <input type="number" id="vaccine-effectiveness" min="0" max="100" step="1" value="98">
        </div>
        <div class="input-container">
            <label for="infection-to-infectious">Infection to Infectious Time (1-30 days):</label><br>
            <input type="number" id="infection-to-infectious" min="1" max="30" step="1" value="8">
        </div>
        <div class="input-container">
            <label for="infectious-period">Infectious Period (1-30 days):</label><br>
            <input type="number" id="infectious-period" min="1" max="30" step="1" value="8">
        </div>
        <button onclick="startSimulation()">Start Simulation</button>
    </div>
    <canvas id="simulationCanvas" width="600" height="600"></canvas>
    <div id="legend" style="margin-top: 10px; font-size: 14px;">
        <span
            style="display: inline-block; width: 20px; height: 20px; background-color: green; border: 1px solid black; margin-right: 5px;"></span>
        Vaccinated and Immune
        <span
            style="display: inline-block; width: 20px; height: 20px; background-color: blue; border: 1px solid black; margin-left: 15px; margin-right: 5px;"></span>
        Vaccinated and Non-Immune
        <span
            style="display: inline-block; width: 20px; height: 20px; background-color: gray; border: 1px solid black; margin-left: 15px; margin-right: 5px;"></span>
        Unvaccinated
        <span
            style="display: inline-block; width: 20px; height: 20px; background-color: red; border: 1px solid black; margin-left: 15px; margin-right: 5px;"></span>
        Infectious
    </div>
    <div id="simulation-timer" style="font-size: 30px; margin-bottom: 10px; margin-top: 20px">0 Days From First Case
    </div>
    <div id="result" style="font-size: 30px"></div>
    <table id="summary-table">
        <thead>
            <tr>
                <th>Group</th>
                <th>Initial Count</th>
                <th>Final Count</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Vaccinated and Immune (Green)</td>
                <td id="initial-immune-count">0</td>
                <td id="final-immune-count">0</td>
            </tr>
            <tr>
                <td>Vaccinated but Non-Immune (Blue)</td>
                <td id="initial-non-immune-vaccinated-count">0</td>
                <td id="final-non-immune-vaccinated-count">0</td>
            </tr>
            <tr>
                <td>Unvaccinated (Gray)</td>
                <td id="initial-unvaccinated-count">0</td>
                <td id="final-unvaccinated-count">0</td>
            </tr>
            <tr>
                <td>Infected (Red)</td>
                <td id="initial-infected-count">0</td>
                <td id="final-infected-count">0</td>
            </tr>
            <tr>
                <td>Recovered (Red to Green)</td>
                <td>0</td>
                <td id="final-recovered-count">0</td>
            </tr>
        </tbody>
    </table>

    <table id="attack-rate-table">
        <thead>
            <tr>
                <th>Metric</th>
                <th>Value</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Attack Rate - Vaccinated</td>
                <td id="attack-rate-vaccinated">0.00</td>
            </tr>
            <tr>
                <td>Attack Rate - Unvaccinated</td>
                <td id="attack-rate-unvaccinated">0.00</td>
            </tr>
            <tr>
                <td>Rate Ratio</td>
                <td id="rate-ratio">0.00</td>
            </tr>
        </tbody>
    </table>

    <script>
        const canvas = document.getElementById('simulationCanvas');
        const ctx = canvas.getContext('2d');
        const populationInput = document.getElementById('population');
        const vaccinatedInput = document.getElementById('vaccinated');
        const infectionRateInput = document.getElementById('infection-rate');
        const initialInfectedInput = document.getElementById('initial-infected');
        const vaccineEffectivenessInput = document.getElementById('vaccine-effectiveness');
        const infectionToInfectiousInput = document.getElementById('infection-to-infectious');
        const infectiousPeriodInput = document.getElementById('infectious-period');
        const resultDiv = document.getElementById('result');
        const initialImmuneCountCell = document.getElementById('initial-immune-count');
        const finalImmuneCountCell = document.getElementById('final-immune-count');
        const initialNonImmuneVaccinatedCountCell = document.getElementById('initial-non-immune-vaccinated-count');
        const finalNonImmuneVaccinatedCountCell = document.getElementById('final-non-immune-vaccinated-count');
        const initialUnvaccinatedCountCell = document.getElementById('initial-unvaccinated-count');
        const finalUnvaccinatedCountCell = document.getElementById('final-unvaccinated-count');
        const initialInfectedCountCell = document.getElementById('initial-infected-count');
        const finalInfectedCountCell = document.getElementById('final-infected-count');
        const finalRecoveredCountCell = document.getElementById('final-recovered-count');

        let particles = [];
        let simulationStartTime;
        let simulationRunning = true;

        function createParticles(populationSize, vaccinatedPercentage, initialInfected, vaccineEffectiveness) {
            particles = [];

            const vaccinatedProportion = vaccinatedPercentage / 100;
            const vaccineEffectivenessProportion = vaccineEffectiveness / 100;

            const vaccinatedCount = Math.floor(populationSize * vaccinatedProportion);
            const immuneCount = Math.floor(vaccinatedCount * vaccineEffectivenessProportion);
            const nonImmuneCount = vaccinatedCount - immuneCount;
            const unvaccinatedCount = populationSize - vaccinatedCount;

            initialImmuneCountCell.textContent = immuneCount;
            initialNonImmuneVaccinatedCountCell.textContent = nonImmuneCount;
            initialUnvaccinatedCountCell.textContent = unvaccinatedCount;
            initialInfectedCountCell.textContent = initialInfected;

            for (let i = 0; i < immuneCount; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    dx: (Math.random() - 0.5) * 2,
                    dy: (Math.random() - 0.5) * 2,
                    infected: false,
                    immune: true,
                    vaccinated: true,
                    infectionsCaused: 0,
                    color: 'green'
                });
            }

            for (let i = 0; i < nonImmuneCount; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    dx: (Math.random() - 0.5) * 2,
                    dy: (Math.random() - 0.5) * 2,
                    infected: false,
                    immune: false,
                    vaccinated: true,
                    infectionsCaused: 0,
                    color: 'blue'
                });
            }

            for (let i = 0; i < unvaccinatedCount; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    dx: (Math.random() - 0.5) * 2,
                    dy: (Math.random() - 0.5) * 2,
                    infected: false,
                    immune: false,
                    vaccinated: false,
                    infectionsCaused: 0,
                    color: 'gray'
                });
            }

            let infectedCount = 0;
            while (infectedCount < initialInfected) {
                const randomIndex = Math.floor(Math.random() * particles.length);
                if (!particles[randomIndex].infected && !particles[randomIndex].immune) {
                    particles[randomIndex].infected = true;
                    particles[randomIndex].color = 'red';
                    particles[randomIndex].infectionTime = Date.now();
                    infectedCount++;
                }
            }
        }

        function updateAttackRatesFromTable() {
            // Get values from the table
            const initialGreenCount = parseInt(document.getElementById('initial-immune-count').textContent);
            const initialBlueCount = parseInt(document.getElementById('initial-non-immune-vaccinated-count').textContent);
            const finalBlueCount = parseInt(document.getElementById('final-non-immune-vaccinated-count').textContent);
            const initialGrayCount = parseInt(document.getElementById('initial-unvaccinated-count').textContent);
            const finalGrayCount = parseInt(document.getElementById('final-unvaccinated-count').textContent);

            // Calculate numerator and denominator for attack rates
            const vaccinatedInfected = initialBlueCount - finalBlueCount;
            const unvaccinatedInfected = initialGrayCount - finalGrayCount;
            const initialVaccinatedTotal = initialGreenCount + initialBlueCount;

            // Calculate attack rates
            const attackRateVaccinated = initialVaccinatedTotal > 0 ? (vaccinatedInfected / initialVaccinatedTotal) : 0;
            const attackRateUnvaccinated = initialGrayCount > 0 ? (unvaccinatedInfected / initialGrayCount) : 0;

            // Calculate rate ratio
            const rateRatio = attackRateUnvaccinated > 0 ? (attackRateVaccinated / attackRateUnvaccinated) : 0;

            // Update the table
            document.getElementById('attack-rate-vaccinated').textContent = attackRateVaccinated.toFixed(8);
            document.getElementById('attack-rate-unvaccinated').textContent = attackRateUnvaccinated.toFixed(8);
            document.getElementById('rate-ratio').textContent = rateRatio.toFixed(8);

            // Debugging logs
            console.log('Vaccinated Infected:', vaccinatedInfected);
            console.log('Unvaccinated Infected:', unvaccinatedInfected);
            console.log('Attack Rate Vaccinated:', attackRateVaccinated);
            console.log('Attack Rate Unvaccinated:', attackRateUnvaccinated);
            console.log('Rate Ratio:', rateRatio);
        }

        function drawParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            particles.forEach(p => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, 5, 0, Math.PI * 2);
                ctx.fillStyle = p.color;
                ctx.fill();
                ctx.closePath();

                p.x += p.dx
                if (p.x < 0 || p.x > canvas.width) p.dx *= -1;
                if (p.y < 0 || p.y > canvas.height) p.dy *= -1;
                // Update movement with randomness
                p.dx += (Math.random() - 0.5) * 0.2;
                p.dy += (Math.random() - 0.5) * 0.2;
                // Limit speed to prevent excessive movement
                const maxSpeed = 2;
                p.dx = Math.max(-maxSpeed, Math.min(maxSpeed, p.dx));
                p.dy = Math.max(-maxSpeed, Math.min(maxSpeed, p.dy));
                // Update positions
                p.x += p.dx;
                p.y += p.dy;
                // Bounce off walls
                if (p.x < 0) {
                    p.x = 0;
                    p.dx *= -1;
                } else if (p.x > canvas.width) {
                    p.x = canvas.width;
                    p.dx *= -1;
                }

                if (p.y < 0) {
                    p.y = 0;
                    p.dy *= -1;
                } else if (p.y > canvas.height) {
                    p.y = canvas.height;
                    p.dy *= -1;
                }
            });
        }
        let totalInfections = 0; // Track total infections during simulation
        const newInfectionsPerSecond = []; // Track new infections per second
        let timerInterval; // To manage timer display

        function resetUI() {
            // Reset the table counts
            finalImmuneCountCell.textContent = "0";
            finalNonImmuneVaccinatedCountCell.textContent = "0";
            finalUnvaccinatedCountCell.textContent = "0";
            finalInfectedCountCell.textContent = "0";
            finalRecoveredCountCell.textContent = "0";

            // Remove any existing histogram
            const existingCanvas = document.querySelector("canvas[style]");
            if (existingCanvas) {
                existingCanvas.remove();
            }

            // Reset timer
            const timerElement = document.getElementById("simulation-timer");
            if (timerElement) {
                timerElement.textContent = "0 Days From First Case";
            }
        }

        function updateParticles(infectionRate, infectionToInfectious, infectiousPeriod) {
            const currentTime = Date.now();
            const elapsedSeconds = Math.floor((currentTime - simulationStartTime) / 1000);

            if (!newInfectionsPerSecond[elapsedSeconds]) {
                newInfectionsPerSecond[elapsedSeconds] = 0;
            }

            particles.forEach(p1 => {
                if (p1.infected) {
                    const timeSinceInfection = (currentTime - p1.infectionTime) / 1000;

                    if (timeSinceInfection >= infectionToInfectious && timeSinceInfection < infectionToInfectious + infectiousPeriod) {
                        particles.forEach(p2 => {
                            if (!p2.infected && (p2.color === 'blue' || p2.color === 'gray') && p1.infectionsCaused < infectionRate) {
                                const dx = p1.x - p2.x;
                                const dy = p1.y - p2.y;
                                const distance = Math.sqrt(dx * dx + dy * dy);

                                if (distance < 10 && Math.random() < 0.1) {
                                    p2.infected = true;
                                    p2.color = 'red';
                                    p2.infectionTime = currentTime;
                                    p1.infectionsCaused++;
                                    totalInfections++; // Increment total infections
                                    newInfectionsPerSecond[elapsedSeconds]++;
                                }
                            }
                        });
                    } else if (timeSinceInfection >= infectionToInfectious + infectiousPeriod) {
                        p1.infected = false;
                        p1.immune = true;
                        p1.color = 'green';
                    }
                }
            });
        }

        function checkSimulationEnd(maxTime, infectionToInfectiousTime) {
            const currentTime = Date.now();
            const elapsedTime = (currentTime - simulationStartTime) / 1000;

            // Check if all reds have recovered
            const noMoreRed = particles.every(p => p.color !== 'red');

            // Check if two incubation periods have passed since the last red particle
            if (noMoreRed) {
                if (!checkSimulationEnd.lastRedTime) {
                    checkSimulationEnd.lastRedTime = currentTime; // Record the time when reds became zero
                }

                const timeSinceLastRed = (currentTime - checkSimulationEnd.lastRedTime) / 1000;
                if (timeSinceLastRed >= 2 * infectionToInfectiousTime) {
                    // Stop the simulation if two incubation periods have passed
                    simulationRunning = false;
                    clearInterval(timerInterval);
                    return elapsedTime;
                }
            } else {
                // Reset the lastRedTime if there are still red particles
                checkSimulationEnd.lastRedTime = null;
            }

            // Stop simulation if maxTime is reached
            if (elapsedTime >= maxTime) {
                simulationRunning = false;
                clearInterval(timerInterval);
                return elapsedTime;
            }

            return null;
        }

        function countFinalParticles(initialGreenCount) {
            const finalCounts = {
                green: 0,
                blue: 0,
                gray: 0,
                red: 0,
                recovered: 0
            };

            particles.forEach(p => {
                if (p.color === 'green') {
                    finalCounts.green++;
                }
                if (p.color === 'blue') {
                    finalCounts.blue++;
                }
                if (p.color === 'gray') {
                    finalCounts.gray++;
                }
                if (p.color === 'red') {
                    finalCounts.red++;
                }
                if (!p.infected && p.immune && p.color === 'green' && finalCounts.green > initialGreenCount) {
                    finalCounts.recovered++;
                }
            });

            // Maintain the initial green count for vaccinated and immune
            finalCounts.green = initialGreenCount;

            finalImmuneCountCell.textContent = initialGreenCount; // Display the initial count unchanged
            finalNonImmuneVaccinatedCountCell.textContent = finalCounts.blue;
            finalUnvaccinatedCountCell.textContent = finalCounts.gray;
            finalInfectedCountCell.textContent = totalInfections; // Use total infections for final red count
            finalRecoveredCountCell.textContent = Math.min(finalCounts.recovered, totalInfections);

            drawHistogram();
            updateAttackRatesFromTable();
        }

        function drawHistogram() {
            const histogramCanvas = document.createElement('canvas');
            const maxInfections = Math.max(...newInfectionsPerSecond);
            const barWidth = 600 / newInfectionsPerSecond.length;
            const barHeightMultiplier = 20; // Adjusts the histogram height scaling
            const canvasHeight = Math.min(600, maxInfections * barHeightMultiplier + 50); // Dynamic height

            histogramCanvas.width = 600;
            histogramCanvas.height = canvasHeight;
            histogramCanvas.style.border = '1px solid black';
            document.body.appendChild(histogramCanvas);

            const ctx = histogramCanvas.getContext('2d');

            newInfectionsPerSecond.forEach((count, index) => {
                const barHeight = (count / maxInfections) * (canvasHeight - 50); // Leave space for labels
                ctx.fillStyle = 'blue';
                ctx.fillRect(index * barWidth, canvasHeight - barHeight - 20, barWidth - 2, barHeight);

                ctx.fillStyle = 'black';
                ctx.font = '10px Arial';
                ctx.fillText(count, index * barWidth + 2, canvasHeight - barHeight - 25);
            });

            ctx.fillStyle = 'black';
            ctx.font = '12px Arial';
            ctx.fillText('Days', 600 / 2 - 20, canvasHeight - 5);
        }

        function startSimulation() {
            resetUI(); // Reset the UI before starting

            const populationSize = parseInt(populationInput.value);
            const vaccinatedPercentage = parseFloat(vaccinatedInput.value);
            const infectionRate = parseFloat(infectionRateInput.options[infectionRateInput.selectedIndex].value);
            const initialInfected = parseInt(initialInfectedInput.value);
            const vaccineEffectiveness = parseFloat(vaccineEffectivenessInput.value);
            const infectionToInfectious = parseFloat(infectionToInfectiousInput.value);
            const infectiousPeriod = parseFloat(infectiousPeriodInput.value);

            totalInfections = initialInfected; // Initialize with initial infected count
            newInfectionsPerSecond.length = 0; // Reset histogram data

            const initialGreenCount = Math.floor(populationSize * (vaccinatedPercentage / 100) * (vaccineEffectiveness / 100));

            createParticles(populationSize, vaccinatedPercentage, initialInfected, vaccineEffectiveness);
            simulationStartTime = Date.now();
            simulationRunning = true;

            // Initialize timer
            const timerElement = document.getElementById("simulation-timer");
            function updateTimer() {
                const currentTime = Date.now();
                const elapsedSeconds = Math.floor((currentTime - simulationStartTime) / 1000);
                document.getElementById("simulation-timer").textContent = `${elapsedSeconds} Days From First Case`;
            }

            function animate() {
                if (!simulationRunning) return;

                updateTimer(); // Update the timer
                drawParticles();
                updateParticles(infectionRate, infectionToInfectious, infectiousPeriod);

                const elapsedTime = checkSimulationEnd(600, infectionToInfectious); // Pass infectionToInfectious time
                if (elapsedTime !== null) {
                    countFinalParticles(initialGreenCount);
                    resultDiv.textContent = `Simulation Ended After ${Math.floor(elapsedTime)} Days From First Case.`;
                } else {
                    requestAnimationFrame(animate);
                }
            }

            resultDiv.textContent = "";
            animate();
        }
    </script>
</body>

</html>
